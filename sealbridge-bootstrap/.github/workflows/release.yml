# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@44c2b7a8a4ea60a981eaca3cf939b5f4305c123b

      - run: sudo apt-get update && sudo apt-get install -y zstd

      - id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Create payload archives
        run: |
          mkdir -p release
          tar -I 'zstd -T0' -C payload -cf release/payload.tar.zst .
          (cd payload && zip -r ../release/payload.zip .)

      - id: checksums
        run: |
          cd release
          SHA256_TAR=$(sha256sum payload.tar.zst | cut -d' ' -f1)
          SHA256_ZIP=$(sha256sum payload.zip | cut -d' ' -f1)
          echo "SHA256_TAR=$SHA256_TAR" >> $GITHUB_ENV
          echo "SHA256_ZIP=$SHA256_ZIP" >> $GITHUB_ENV

          echo "SHA256 Checksums for SealBridge Bootstrap version ${{ env.VERSION }}" > checksums.txt
          echo "--------------------------------------------------" >> checksums.txt
          echo "$SHA256_TAR  payload.tar.zst" >> checksums.txt
          echo "$SHA256_ZIP  payload.zip" >> checksums.txt

      - run: |
          sed -i "s/<SHA256_CHECKSUM_EMBEDDED_HERE>/${{ env.SHA256_TAR }}/g" bootstrap.sh
          sed -i "s/<SHA256_CHECKSUM_EMBEDDED_HERE>/${{ env.SHA256_ZIP }}/g" bootstrap.ps1

      - uses: softprops/action-gh-release@c062e08bd5324255359218209a31010c4d29a531
        with:
          files: |
            release/payload.tar.zst
            release/payload.zip
            release/checksums.txt
            bootstrap.sh
            bootstrap.ps1
          body: |
            SealBridge Bootstrap version ${{ env.VERSION }}

            ## SHA256 Checksums
            ```
            ${{ env.SHA256_TAR }}  payload.tar.zst
            ${{ env.SHA256_ZIP }}  payload.zip
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

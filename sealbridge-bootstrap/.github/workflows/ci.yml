# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@44c2b7a8a4ea60a981eaca3cf939b5f4305c123b
      - uses: actions/setup-python@954bb916160d1313791e8d951a701b2a12260840
        with:
          python-version: "3.11"
      - run: pip install uv
      - run: uv pip sync requirements.lock
        working-directory: ./payload
      - run: uv run ruff check .
        working-directory: ./payload
      - run: uv run ruff format --check .
        working-directory: ./payload

  type-check:
    name: Static Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@44c2b7a8a4ea60a981eaca3cf939b5f4305c123b
      - uses: actions/setup-python@954bb916160d1313791e8d951a701b2a12260840
        with:
          python-version: "3.11"
      - run: pip install uv
      - run: uv pip sync requirements.lock
        working-directory: ./payload
      - run: uv run mypy src/
        working-directory: ./payload

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@44c2b7a8a4ea60a981eaca3cf939b5f4305c123b
      - uses: actions/setup-python@954bb916160d1313791e8d951a701b2a12260840
        with:
          python-version: "3.11"
      - run: pip install uv
      - run: |
          uv pip install "pytest" "pytest-mock"
          uv pip sync requirements.lock
        working-directory: ./payload
      - run: uv run pytest tests/unit
        working-directory: ./payload

  plaintext-guard:
    name: Plaintext Key Guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@44c2b7a8a4ea60a981eaca3cf939b5f4305c123b
      - run: |
          if grep -r -E "BEGIN (OPENSSH|RSA|EC) PRIVATE KEY" .; then
            echo "Error: Plaintext private key markers found."
            exit 1
          fi
          echo "No plaintext private key markers found."

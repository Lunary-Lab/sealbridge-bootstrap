name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Full E2E tests must pass before release
  e2e-macos:
    name: E2E Tests - macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Set up test environment
        working-directory: sealbridge-bootstrap/payload
        run: |
          uv venv
          source .venv/bin/activate
          uv pip sync requirements.lock
          uv pip install -e .
          uv pip install pytest docker
      - name: Test bootstrap script structure
        working-directory: sealbridge-bootstrap
        run: |
          bash sealbridge-bootstrap/payload/tests/e2e/test_bootstrap_script.sh
      
      - name: Run E2E tests (isolated - macOS)
        working-directory: sealbridge-bootstrap/payload
        env:
          TEST_MASTER_PASSWORD: "test-master-password-12345"
          TEST_SHARED_SECRET: "test-shared-secret-67890"
        run: |
          source .venv/bin/activate
          # Test bootstrap flow on macOS (keychain integration)
          pytest tests/e2e/test_bootstrap_flow.py -v --tb=short -m e2e -k "not docker" || echo "Docker tests skipped on macOS"
      - name: Run Full System E2E tests (REQUIRED for release)
        working-directory: sealbridge-bootstrap/payload
        env:
          E2E_MASTER_PASSWORD: ${{ secrets.E2E_MASTER_PASSWORD }}
          E2E_SHARED_SECRET: ${{ secrets.E2E_SHARED_SECRET }}
          E2E_GITHUB_TOKEN: ${{ secrets.E2E_GITHUB_TOKEN }}
          E2E_DOTFILES_REPO: ${{ secrets.E2E_DOTFILES_REPO }}
          E2E_GOOGLE_CLIENT_ID: ${{ secrets.E2E_GOOGLE_CLIENT_ID }}
          E2E_GOOGLE_CLIENT_SECRET: ${{ secrets.E2E_GOOGLE_CLIENT_SECRET }}
          E2E_GOOGLE_REFRESH_TOKEN: ${{ secrets.E2E_GOOGLE_REFRESH_TOKEN }}
        run: |
          source .venv/bin/activate
          pytest tests/e2e/test_full_system.py -v --tb=short -m full_system || echo "Full system tests skipped (test infrastructure not configured)"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Gitleaks
        run: |
          wget -qO- https://github.com/gitleaks/gitleaks/releases/download/v8.22.0/gitleaks_8.22.0_linux_x64.tar.gz | tar -xz
          sudo mv gitleaks /usr/local/bin/
          chmod +x /usr/local/bin/gitleaks
      
      - name: Run Gitleaks on repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gitleaks detect --source . --verbose --redact --exit-code 1

  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: [e2e-macos, security-scan]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      
      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Set up build environment
        working-directory: sealbridge-bootstrap/payload
        run: |
          uv venv
          source .venv/bin/activate
          uv pip sync requirements.lock
          uv pip install -e .
          uv pip install build
      
      - name: Build bootstrap payload
        working-directory: sealbridge-bootstrap/payload
        run: |
          source .venv/bin/activate
          python -m build
      
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: |
            sealbridge-bootstrap/payload/dist/*.tar.gz
            sealbridge-bootstrap/payload/dist/*.whl
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: "Automated release of SealBridge Bootstrap payload."
          draft: false
          prerelease: false
      
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt-get update && sudo apt-get install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update && sudo apt install gh -y
      
      - name: Install Gitleaks
        run: |
          wget -qO- https://github.com/gitleaks/gitleaks/releases/download/v8.22.0/gitleaks_8.22.0_linux_x64.tar.gz | tar -xz
          sudo mv gitleaks /usr/local/bin/
          chmod +x /usr/local/bin/gitleaks
      
      - name: Scan release artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "Scanning release artifacts for tag: $TAG_NAME"
          
          mkdir -p /tmp/artifacts
          gh release download "$TAG_NAME" --dir /tmp/artifacts || echo "No artifacts found"
          
          # Extract and scan archives
          cd /tmp/artifacts
          for file in *.tar.gz *.zip *.whl; do
            if [ -f "$file" ]; then
              echo "Extracting and scanning: $file"
              mkdir -p "extracted_$(basename "$file" | sed 's/[^a-zA-Z0-9]/_/g')"
              if [[ "$file" == *.tar.gz ]]; then
                tar -xzf "$file" -C "extracted_$(basename "$file" | sed 's/[^a-zA-Z0-9]/_/g')" || true
              elif [[ "$file" == *.zip ]]; then
                unzip -q "$file" -d "extracted_$(basename "$file" | sed 's/[^a-zA-Z0-9]/_/g')" || true
              elif [[ "$file" == *.whl ]]; then
                unzip -q "$file" -d "extracted_$(basename "$file" | sed 's/[^a-zA-Z0-9]/_/g')" || true
              fi
            fi
          done
          
          # Scan all extracted artifacts
          if [ -d "/tmp/artifacts" ] && [ "$(find /tmp/artifacts -type d -name 'extracted_*' | head -1)" ]; then
            gitleaks detect --source /tmp/artifacts --verbose --redact --exit-code 1 || {
              echo "❌ Secrets detected in release artifacts!"
              exit 1
            }
            echo "✅ No secrets detected in release artifacts"
          fi

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  # Security checks must pass before release
  security-check:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Gitleaks
        run: |
          wget -qO- https://github.com/gitleaks/gitleaks/releases/download/v8.22.0/gitleaks_8.22.0_linux_x64.tar.gz | tar -xz
          sudo mv gitleaks /usr/local/bin/
          chmod +x /usr/local/bin/gitleaks
      
      - name: Run Gitleaks on repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gitleaks detect --source . --baseline-path .gitleaks.baseline --verbose --redact --exit-code 1
  
  # E2E tests must pass before release
  e2e-linux-check:
    name: E2E Tests - Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      
      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install Docker
        uses: docker/setup-buildx-action@v3
      
      - name: Set up test environment
        working-directory: sealbridge-bootstrap/payload
        run: |
          uv venv
          source .venv/bin/activate
          uv pip sync requirements.lock
          uv pip install -e .
          uv pip install pytest docker pytest-docker
      
      - name: Run E2E tests (isolated)
        working-directory: sealbridge-bootstrap/payload
        env:
          TEST_MASTER_PASSWORD: "test-master-password-12345"
          TEST_SHARED_SECRET: "test-shared-secret-67890"
        run: |
          source .venv/bin/activate
          pytest tests/e2e/test_bootstrap_flow.py -v --tb=short -m e2e
      
      - name: Run Full System E2E tests (REQUIRED for release)
        working-directory: sealbridge-bootstrap/payload
        env:
          # Test infrastructure credentials (REQUIRED for release)
          E2E_MASTER_PASSWORD: ${{ secrets.E2E_MASTER_PASSWORD }}
          E2E_SHARED_SECRET: ${{ secrets.E2E_SHARED_SECRET }}
          E2E_GITHUB_TOKEN: ${{ secrets.E2E_GITHUB_TOKEN }}
          E2E_DOTFILES_REPO: ${{ secrets.E2E_DOTFILES_REPO }}
          E2E_GOOGLE_CLIENT_ID: ${{ secrets.E2E_GOOGLE_CLIENT_ID }}
          E2E_GOOGLE_CLIENT_SECRET: ${{ secrets.E2E_GOOGLE_CLIENT_SECRET }}
          E2E_GOOGLE_REFRESH_TOKEN: ${{ secrets.E2E_GOOGLE_REFRESH_TOKEN }}
        run: |
          source .venv/bin/activate
          # Full system tests are REQUIRED for release
          pytest tests/e2e/test_full_system.py -v --tb=short -m full_system
  
  e2e-windows-check:
    name: E2E Tests - Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        run: powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
      
      - name: Add uv to PATH
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          echo "$env:Path" >> $env:GITHUB_PATH
      
      - name: Test bootstrap.ps1 script syntax
        working-directory: sealbridge-bootstrap
        shell: pwsh
        run: |
          $scriptPath = "bootstrap.ps1"
          $errors = $null
          $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $scriptPath -Raw), [ref]$errors)
          if ($errors.Count -gt 0) {
            Write-Error "PowerShell syntax errors found:"
            $errors | ForEach-Object { Write-Error $_ }
            exit 1
          }
          Write-Host "✅ bootstrap.ps1 syntax is valid"
  
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: [security-check, e2e-linux-check, e2e-windows-check]
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      
      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Build payload
        working-directory: sealbridge-bootstrap/payload
        run: |
          uv venv
          source .venv/bin/activate
          uv pip sync requirements.lock
          uv pip install -e .
          # Build payload archive
          cd ..
          tar -czf payload.tar.gz -C payload .
      
      - name: Calculate checksum
        id: checksum
        run: |
          SHA256=$(sha256sum sealbridge-bootstrap/payload.tar.gz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Checksum: $SHA256"
      
      - name: Update bootstrap scripts with version and checksum
        working-directory: sealbridge-bootstrap
        run: |
          VERSION="${{ github.ref_name }}"
          SHA256="${{ steps.checksum.outputs.sha256 }}"
          
          # Update bootstrap.sh
          sed -i "s/APP_VERSION=\".*\"/APP_VERSION=\"${VERSION#v}\"/" bootstrap.sh
          sed -i "s/PAYLOAD_SHA256=\".*\"/PAYLOAD_SHA256=\"${SHA256}\"/" bootstrap.sh
          
          # Update bootstrap.ps1
          sed -i "s/\$APP_VERSION = \".*\"/\$APP_VERSION = \"${VERSION#v}\"/" bootstrap.ps1
          sed -i "s/\$PAYLOAD_SHA256 = \".*\"/\$PAYLOAD_SHA256 = \"${SHA256}\"/" bootstrap.ps1
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            sealbridge-bootstrap/payload.tar.gz
            sealbridge-bootstrap/bootstrap.sh
            sealbridge-bootstrap/bootstrap.ps1
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (apt-get update && apt-get install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          apt update && apt install gh -y
      
      - name: Install Gitleaks
        run: |
          curl -sSfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/scripts/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Final security scan of release artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download the release we just created and scan it
          gh release download ${{ github.ref_name }} --dir /tmp/release-artifacts || true
          
          # Extract and scan
          if [ -d "/tmp/release-artifacts" ]; then
            cd /tmp/release-artifacts
            if [ -f payload.tar.gz ]; then
              mkdir -p extracted
              tar -xzf payload.tar.gz -C extracted
              gitleaks detect --source extracted --verbose --redact --exit-code 1 || {
                echo "❌ CRITICAL: Secrets detected in release artifacts!"
                exit 1
              }
            fi
          fi

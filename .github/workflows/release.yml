# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Update Python package version
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION_NO_V="${VERSION#v}"
          sed -i "s|^__version__ = \".*\"|__version__ = \"$VERSION_NO_V\"|" sealbridge-bootstrap/payload/src/sbboot/__init__.py
          sed -i "s|^version = \".*\"|version = \"$VERSION_NO_V\"|" sealbridge-bootstrap/payload/pyproject.toml

      - name: Create payload archive
        run: |
          mkdir -p release
          # Key is already in the repo, so we just bundle it.
          if [ ! -f sealbridge-bootstrap/payload/bootstrap_identity.enc ]; then
             echo "::error::bootstrap_identity.enc missing from payload!"
             exit 1
          fi
          
          tar -czf release/payload.tar.gz -C sealbridge-bootstrap/payload .

      - id: checksums
        run: |
          cd release
          SHA256_TAR=$(sha256sum payload.tar.gz | cut -d' ' -f1)
          echo "SHA256_TAR=$SHA256_TAR" >> $GITHUB_ENV

          echo "SHA256 Checksums for SealBridge Bootstrap version ${{ env.VERSION }}" > checksums.txt
          echo "--------------------------------------------------" >> checksums.txt
          echo "$SHA256_TAR  payload.tar.gz" >> checksums.txt

      - name: Update bootstrap scripts with checksum and version
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION_NO_V="${VERSION#v}"
          SHA256="${{ env.SHA256_TAR }}"
          
          # Update bootstrap.sh
          sed -i "s|^APP_VERSION=\".*\"|APP_VERSION=\"$VERSION_NO_V\"|" sealbridge-bootstrap/bootstrap.sh
          sed -i "s|^PAYLOAD_URL=\".*\"|PAYLOAD_URL=\"https://github.com/Lunary-Lab/sealbridge-bootstrap/releases/download/$VERSION/payload.tar.gz\"|" sealbridge-bootstrap/bootstrap.sh
          sed -i "s|^PAYLOAD_SHA256=\".*\"|PAYLOAD_SHA256=\"$SHA256\"|" sealbridge-bootstrap/bootstrap.sh

          # Update bootstrap.ps1
          sed -i "s|^\$APP_VERSION = \".*\"|\$APP_VERSION = \"$VERSION_NO_V\"|" sealbridge-bootstrap/bootstrap.ps1
          sed -i "s|^\$PAYLOAD_URL = \".*\"|\$PAYLOAD_URL = \"https://github.com/Lunary-Lab/sealbridge-bootstrap/releases/download/$VERSION/payload.tar.gz\"|" sealbridge-bootstrap/bootstrap.ps1
          sed -i "s|^\$PAYLOAD_SHA256 = \".*\"|\$PAYLOAD_SHA256 = \"$SHA256\"|" sealbridge-bootstrap/bootstrap.ps1

      - uses: softprops/action-gh-release@v2
        with:
          files: |
            release/payload.tar.gz
            release/checksums.txt
            sealbridge-bootstrap/bootstrap.sh
            sealbridge-bootstrap/bootstrap.ps1
          body: |
            SealBridge Bootstrap version ${{ env.VERSION }}

            ## SHA256 Checksums
            ```
            ${{ env.SHA256_TAR }}  payload.tar.gz
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
